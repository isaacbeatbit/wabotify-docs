---
title: Services
description: Gu√≠a completa para conectar el Agente de IA con servicios externos usando APIs REST.
---

import { Aside } from "@astrojs/starlight/components";

# Servicios API

Gu√≠a completa para conectar el Agente de IA con servicios externos usando APIs REST.

## Configuraci√≥n de los Servicios de Agentes IA

Los servicios permiten que tu agente de IA se conecte con APIs externas para ejecutar acciones complejas como consultar bases de datos, realizar reservas, procesar pagos, o cualquier integraci√≥n que necesites. El agente recolectar√° autom√°ticamente la informaci√≥n necesaria del usuario antes de llamar a la API.

<Aside title="Nota">
  Los servicios est√°n en **Producci√≥n Estable** y han demostrado alta
  fiabilidad. El sistema maneja autom√°ticamente la recolecci√≥n de datos,
  validaci√≥n y ejecuci√≥n de APIs externas.
</Aside>

## Flujo de Funcionamiento

1. **Detecci√≥n de Intenci√≥n**: La IA identifica que el usuario quiere usar un servicio.
2. **Recolecci√≥n de Datos**: El agente pregunta por los campos requeridos que falten.
3. **Validaci√≥n**: Se validan los tipos de datos antes de enviar.
4. **Llamada a API**: Se ejecuta la llamada HTTP con los datos recolectados.
5. **Procesamiento**: Se mapea la respuesta seg√∫n `responseMapping`.
6. **Respuesta Final**: Se env√≠a la respuesta personalizada al usuario.

## Estructura Completa

```json
{
  "services": [
    {
      "intent": "schedule_appointment",
      "reference": "Servicio para agendar citas m√©dicas en la cl√≠nica",
      "enabled": true,
      "method": "POST",
      "requiredFields": [
        {
          "name": "nombre",
          "description": "Nombre completo del paciente",
          "promptHint": "¬øPodr√≠as indicarme tu nombre completo, por favor?",
          "type": "string"
        },
        {
          "name": "email",
          "description": "Correo electr√≥nico para confirmaciones",
          "promptHint": "¬øCu√°l es tu direcci√≥n de correo electr√≥nico?",
          "type": "email"
        },
        {
          "name": "fecha",
          "description": "Fecha y hora preferida para la cita",
          "promptHint": "¬øQu√© d√≠a y hora te gustar√≠a agendar? (Ejemplo: ma√±ana a las 3pm)",
          "type": "date"
        },
        {
          "name": "telefono",
          "description": "N√∫mero de tel√©fono de contacto",
          "promptHint": "¬øCu√°l es tu n√∫mero de tel√©fono?",
          "type": "phone"
        }
      ],
      "endpoint": "https://api.clinica.com/v1/appointments",
      "tags": ["citas", "agendamiento", "medical"],
      "headers": {
        "Authorization": "Bearer {{apiKey}}",
        "Content-Type": "application/json",
        "X-Clinic-ID": "clinic_123"
      },
      "bodyTemplate": {
        "patient_name": "{{nombre}}",
        "patient_email": "{{email}}",
        "appointment_date": "{{fecha|format('yyyy-MM-dd HH:mm')}}",
        "phone": "{{telefono}}",
        "source": "wabotify_ai"
      },
      "responseMapping": {
        "appointmentId": "$.data.appointment_id",
        "confirmedDate": "$.data.scheduled_date",
        "doctorName": "$.data.doctor.name",
        "status": "$.status",
        "errorMessage": "$.error.message"
      },
      "responseMessage": "¬°Perfecto! Tu cita ha sido agendada para el {{confirmedDate}} con {{doctorName}}. ID de cita: {{appointmentId}}",
      "responseConditions": [
        {
          "condition": "$.status == 'success'",
          "message": "‚úÖ ¬°Cita confirmada! Te esperamos el {{confirmedDate}} con {{doctorName}}. Recibir√°s un recordatorio por email.",
          "nextService": "verify_contact_info"
        },
        {
          "condition": "$.status == 'conflict'",
          "message": "‚ùå Lo siento, ese horario no est√° disponible. ¬øTe gustar√≠a que te sugiera horarios libres?",
          "nextService": "verify_contact_info"
        },
        {
          "condition": "$.status == 'error'",
          "message": "‚ö†Ô∏è Hubo un problema al agendar: {{errorMessage}}. ¬øPodr√≠as intentar con otra fecha?",
          "nextService": "verify_contact_info"
        }
      ],
      "action": "notify_doctor"
    }
  ]
}
```

---

## Variables del Servicio

Las variables del sistema son valores predefinidos que el agente puede utilizar autom√°ticamente en los servicios. Estas variables se actualizan din√°micamente durante la conversaci√≥n y proporcionan informaci√≥n contextual importante.

**Sintaxis:** `[nombreVariable]`

**Solo disponibles en:** Secci√≥n Servicios

| Variable            | Descripci√≥n                                 | Tipo     | Ejemplo                               |
| ------------------- | ------------------------------------------- | -------- | ------------------------------------- |
| `[lastmessagetime]` | Fecha y hora del √∫ltimo mensaje del usuario | Sistema  | `2024-08-31 18:53:28`                 |
| `[sessionId]`       | ID √∫nico de la sesi√≥n actual                | Sistema  | `sess_abc123def456`                   |
| `[agentId]`         | ID √∫nico del agente actual                  | Sistema  | `agent_xyz789`                        |
| `[lastmessage]`     | √öltimo mensaje del usuario                  | Sistema  | `"Hola, necesito agendar una cita"`   |
| `[lastmessageIA]`   | √öltima respuesta del agente                 | Sistema  | `"¬°Hola! Te ayudo a agendar tu cita"` |
| `[urlTempFile]`     | URL temporal de archivos adjuntos           | Din√°mico | `https://temp.wabotify.com/file123`   |

### Ubicaciones de uso

- **Endpoints**: Para incluir variables del sistema en las URLs
- **Headers**: Para autenticaci√≥n o identificaci√≥n
- **Body templates**: Para enviar datos contextuales
- **Respuestas**: Para personalizar mensajes

---

## Ejemplo de Uso

```json
"services": [
  {
    "intent": "conversar_humano",
    "reference": "Transferir conversaci√≥n a agente humano cuando el cliente confirma que quiere hablar con una persona despu√©s de que el asistente virtual le ofrece soporte humano en la conversaci√≥n. El cliente puede responder con confirmaciones como s√≠, ok, por favor, perfecto cuando se le pregunta si desea conversar con un agente humano.",
    "enabled": true,
    "method": "POST",
    "requiredFields": [
      {
        "name": "curp",
        "description": "Valor del Curp",
        "promptHint": "Cual es tu curp?",
        "type": "string"
      }
    ],
    "tags": [
      "humano", "agente", "conversar", "si", "s√≠", "por favor", "claro", "perfecto", "dale"
    ],
    "endpoint": "https://hook.us1.make.com/8dvokk7w5rqvlnbq9ibekj9vurqhprsy",
    "headers": {
      "content-type": "application/json"
    },
    "bodyTemplate": {
      "curp": "{{curp}}",
      "lastmessage": "[lastmessage]",
      "messageIA": "[lastmessageIA]",
      "fecha": "[lastmessagetime]",
      "sessionId": "[sessionId]"
    },
    "responseMessage": "Validaremos la informacion.",
    "action": ""
  }
]
```

---

## Campos del Servicio

| Campo                | Tipo    | Requerido | Descripci√≥n                                                         |
| -------------------- | ------- | --------- | ------------------------------------------------------------------- |
| `intent`             | string  | ‚úÖ S√≠     | Identificador √∫nico del servicio (ej: `schedule_appointment`)       |
| `reference`          | string  | ‚úÖ S√≠     | Descripci√≥n clara para que la IA entienda cu√°ndo usar este servicio |
| `enabled`            | boolean | ‚úÖ S√≠     | Si el servicio est√° activo (`true`) o deshabilitado (`false`)       |
| `method`             | string  | ‚úÖ S√≠     | M√©todo HTTP: `GET`, `POST`, `PUT`, `DELETE`                         |
| `endpoint`           | string  | ‚úÖ S√≠     | URL completa de la API externa                                      |
| `requiredFields`     | array   | ‚úÖ S√≠     | Lista de campos que el usuario debe proporcionar                    |
| `headers`            | object  | ‚ùå No     | Headers HTTP personalizados                                         |
| `bodyTemplate`       | object  | ‚ùå No     | Estructura del body para requests                                   |
| `responseMapping`    | object  | ‚ùå No     | Mapeo de la respuesta usando JSONPath                               |
| `responseMessage`    | string  | ‚ùå No     | Mensaje de √©xito predeterminado                                     |
| `responseConditions` | array   | ‚ùå No     | Respuestas condicionales basadas en el resultado                    |
| `tags`               | array   | ‚ùå No     | Etiquetas para clasificar el servicio                               |
| `action`             | string  | ‚ùå No     | Acci√≥n a ejecutar despu√©s del servicio                              |

### Configuraci√≥n de Required Fields

| Campo         | Tipo   | Requerido | Descripci√≥n                                |
| ------------- | ------ | --------- | ------------------------------------------ |
| `name`        | string | ‚úÖ S√≠     | Nombre de la variable (sin espacios)       |
| `description` | string | ‚úÖ S√≠     | Descripci√≥n del campo para la IA           |
| `promptHint`  | string | ‚úÖ S√≠     | Pregunta espec√≠fica para obtener este dato |
| `type`        | string | ‚úÖ S√≠     | Tipo de dato esperado                      |

---

## Tipos de Datos Soportados

| Tipo      | Descripci√≥n                | Ejemplo de Valor        |
| --------- | -------------------------- | ----------------------- |
| `string`  | Texto libre                | `"Juan P√©rez"`          |
| `email`   | Direcci√≥n de correo v√°lida | `"usuario@email.com"`   |
| `phone`   | N√∫mero de tel√©fono         | `"+51987654321"`        |
| `date`    | Fecha y hora               | `"2024-03-15 14:30"`    |
| `number`  | N√∫mero entero o decimal    | `150` o `99.99`         |
| `boolean` | Verdadero o falso          | `true` / `false`        |
| `url`     | URL v√°lida                 | `"https://ejemplo.com"` |

<Aside title="Importante" type="caution">
  Los campos de tipo `date` son procesados inteligentemente por la IA. El
  usuario puede escribir ‚Äúma√±ana a las 3pm‚Äù y se convertir√° autom√°ticamente al
  formato correcto.
</Aside>

---

## Headers Comunes

### Autenticaci√≥n Bearer Token

```json
{
  "headers": {
    "Authorization": "Bearer {{apiKey}}",
    "Content-Type": "application/json"
  }
}
```

### Autenticaci√≥n API Key

```json
{
  "headers": {
    "X-API-Key": "{{apiKey}}",
    "Content-Type": "application/json"
  }
}
```

### Headers Personalizados

```json
{
  "headers": {
    "Authorization": "Bearer {{token}}",
    "Content-Type": "application/json",
    "X-Client-ID": "wabotify",
    "X-Version": "2.0",
    "Accept": "application/json"
  }
}
```

---

## Body Template con Formateo

### Formateo de Fechas

```json
{
  "bodyTemplate": {
    "appointment_date": "{{fecha|format('yyyy-MM-dd')}}",
    "appointment_time": "{{fecha|format('HH:mm')}}",
    "timestamp": "{{fecha|format('yyyy-MM-dd HH:mm:ss')}}"
  }
}
```

### Variables Condicionales

```json
{
  "bodyTemplate": {
    "customer_name": "{{nombre}}",
    "email": "{{email}}",
    "phone": "{{telefono|default('Sin tel√©fono')}}",
    "priority": "{{vip|default(false)}}"
  }
}
```

---

## Response Mapping Avanzado

### Mapeo B√°sico

```json
{
  "responseMapping": {
    "id": "$.data.id",
    "status": "$.status",
    "message": "$.data.message"
  }
}
```

### Mapeo de Arrays

```json
{
  "responseMapping": {
    "availableSlots": "$.data.available_times[*]",
    "firstSlot": "$.data.available_times[0]",
    "doctorName": "$.data.doctors[0].name"
  }
}
```

### Mapeo Condicional

```json
{
  "responseMapping": {
    "result": "$.success",
    "appointmentId": "$.data.appointment_id",
    "errorCode": "$.error.code",
    "errorMessage": "$.error.message"
  }
}
```

---

## Respuestas Condicionales

### Configuraci√≥n Avanzada

```json
{
  "responseConditions": [
    {
      "condition": "$.success == true",
      "message": "‚úÖ ¬°√âxito! Tu solicitud fue procesada. ID: {{appointmentId}}"
    },
    {
      "condition": "$.error.code == 'SLOT_UNAVAILABLE'",
      "message": "‚ùå Ese horario no est√° disponible. Horarios libres: {{availableSlots}}"
    },
    {
      "condition": "$.error.code == 'INVALID_EMAIL'",
      "message": "‚ö†Ô∏è El email proporcionado no es v√°lido. ¬øPodr√≠as verificarlo?"
    },
    {
      "condition": "$.status == 'pending'",
      "message": "‚è≥ Tu solicitud est√° en revisi√≥n. Te contactaremos en 24 horas."
    }
  ]
}
```

### Condiciones con M√∫ltiples Valores

```json
{
  "responseConditions": [
    {
      "condition": "$.status in ['success', 'confirmed']",
      "message": "‚úÖ Procesado exitosamente: {{message}}"
    },
    {
      "condition": "$.status in ['error', 'failed'] && $.error.code == 'PAYMENT_FAILED'",
      "message": "üí≥ Error de pago: {{errorMessage}}. ¬øQuieres intentar con otra tarjeta?"
    }
  ]
}
```

---

## Ejemplos por Casos de Uso

### Agendar Cita M√©dica

```json
{
  "intent": "agendar_cita_medica",
  "reference": "Servicio para agendar citas m√©dicas con doctores especialistas",
  "enabled": true,
  "method": "POST",
  "requiredFields": [
    {
      "name": "paciente",
      "description": "Nombre completo del paciente",
      "promptHint": "¬øCu√°l es el nombre completo del paciente?",
      "type": "string"
    },
    {
      "name": "especialidad",
      "description": "Especialidad m√©dica requerida",
      "promptHint": "¬øQu√© especialidad m√©dica necesitas? (cardiolog√≠a, dermatolog√≠a, etc.)",
      "type": "string"
    },
    {
      "name": "fecha_preferida",
      "description": "Fecha y hora preferida",
      "promptHint": "¬øCu√°ndo te gustar√≠a agendar la cita?",
      "type": "date"
    }
  ],
  "endpoint": "https://api.hospital.com/v2/appointments",
  "headers": {
    "Authorization": "Bearer {{hospitalApiKey}}",
    "Content-Type": "application/json"
  },
  "bodyTemplate": {
    "patient_name": "{{paciente}}",
    "specialty": "{{especialidad}}",
    "preferred_date": "{{fecha_preferida|format('yyyy-MM-dd HH:mm')}}",
    "booking_source": "ai_assistant"
  }
}
```

### Consulta de Productos

```json
{
  "intent": "consultar_producto",
  "reference": "Buscar informaci√≥n detallada de productos en el cat√°logo",
  "enabled": true,
  "method": "GET",
  "requiredFields": [
    {
      "name": "producto",
      "description": "Nombre o c√≥digo del producto",
      "promptHint": "¬øQu√© producto te interesa consultar?",
      "type": "string"
    }
  ],
  "endpoint": "https://api.tienda.com/products/search?q={{producto}}",
  "headers": {
    "X-API-Key": "{{storeApiKey}}"
  },
  "responseMapping": {
    "productName": "$.data[0].name",
    "price": "$.data[0].price",
    "stock": "$.data[0].stock",
    "description": "$.data[0].description"
  },
  "responseMessage": "üì¶ **{{productName}}**\nüí∞ Precio: ${{price}}\nüìä Stock: {{stock}} unidades\nüìù {{description}}"
}
```

### Procesar Pago

```json
{
  "intent": "procesar_pago",
  "reference": "Procesar pagos de √≥rdenes usando gateway de pagos",
  "enabled": true,
  "method": "POST",
  "requiredFields": [
    {
      "name": "monto",
      "description": "Monto a cobrar",
      "promptHint": "¬øCu√°l es el monto a cobrar?",
      "type": "number"
    },
    {
      "name": "email_cliente",
      "description": "Email del cliente",
      "promptHint": "¬øCu√°l es el email del cliente?",
      "type": "email"
    }
  ],
  "endpoint": "https://api.payments.com/v1/charges",
  "headers": {
    "Authorization": "Bearer {{paymentApiKey}}",
    "Content-Type": "application/json"
  },
  "bodyTemplate": {
    "amount": "{{monto}}",
    "currency": "USD",
    "customer_email": "{{email_cliente}}",
    "description": "Pago procesado por IA Assistant"
  },
  "responseConditions": [
    {
      "condition": "$.status == 'succeeded'",
      "message": "‚úÖ ¬°Pago exitoso! ID de transacci√≥n: {{transactionId}}"
    },
    {
      "condition": "$.status == 'failed'",
      "message": "‚ùå El pago fall√≥: {{errorMessage}}"
    }
  ]
}
```

<Aside title="Importante" type="caution">
  **Nunca hardcodees API keys** en la configuraci√≥n. Usa siempre variables como
  `{{ apiKey }}` que se configuran de forma segura en el panel de Wabotify.
</Aside>
